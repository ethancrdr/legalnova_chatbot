<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nover BOT - Test LegalNova</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; padding: 20px; }
    .chat { max-width: 600px; margin: 0 auto; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    .header { background: #00a884; color: white; padding: 15px; text-align: center; font-size: 18px; }
    .messages { height: 70vh; overflow-y: auto; padding: 20px; background: #fff; }
    .message { margin: 10px 0; padding: 10px 15px; border-radius: 18px; max-width: 80%; line-height: 1.5; }
    .bot { background: #e3f2fd; align-self: flex-start; border-bottom-left-radius: 5px; }
    .user { background: #00a884; color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 5px; }
    .input-area { padding: 15px; background: #f8f9fa; display: flex; gap: 10px; }
    input { flex: 1; padding: 15px; border: none; border-radius: 25px; font-size: 16px; }
    button { background: #00a884; color: white; border: none; width: 55px; height: 50px; border-radius: 50%; font-size: 15px; cursor: pointer; }
    a { color: #0066ff; text-decoration: underline; word-break: break-all; }
  </style>
</head>
<body>
  <div class="chat">
    <div class="header">Nover BOT - LegalNova (Demo)</div>
    <div class="messages" id="messages"></div>
    <div class="input-area">
      <input type="text" id="input" placeholder="Escribe aquí..." autocomplete="off">
      <button onclick="enviar()">Enviar</button>
    </div>
  </div>

  <script>
    const messagesDiv = document.getElementById('messages');
    const input = document.getElementById('input'); // Ya definido aquí arriba

    function convertUrls(text) {
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        // La bandera 'g' asegura que se reemplacen todas las ocurrencias
        return text.replace(urlRegex, '<a href="$1" target="_blank">$1</a>');
    }

    function addMessage(text, type) {
        const div = document.createElement('div');
        div.className = `message ${type}`;
        // Reemplaza saltos de línea y convierte URLs
        div.innerHTML = convertUrls(text.replace(/\n/g, '<br>')); 
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    async function enviar() {
        const msg = input.value.trim(); // Usamos el 'input' que definimos al inicio

        if (msg === "") return;

        // 1. Mostrar mensaje del usuario y limpiar input
        addMessage(msg, 'user');
        input.value = ""; 

        try {
            const response = await fetch('/webhook', {  // ✅ Ruta relativa, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true' 
                },
                body: JSON.stringify({ 
                    message: msg,
                    historial: ""
                })
            });

            if (!response.ok) {
                // El servidor respondió, pero con un error HTTP (4xx o 5xx)
                throw new Error(`Error HTTP: ${response.status}`);
            }

            const data = await response.json();
            console.log("Respuesta del servidor:", data);
            
            // 2. MOSTRAR RESPUESTA DEL BOT
            addMessage(data.response, 'bot'); 

        } catch (error) {
            console.error('Error al conectar/procesar:', error);
            // Mostrar error en el chat para el usuario
            addMessage(`⚠️ Lo siento, ocurrió un error: ${error.message}`, 'bot');
        }
    }
    
    // Función para enviar con la tecla Enter (para una mejor experiencia de usuario)
    input.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            enviar();
        }
    });

    // Mensaje de bienvenida inicial
    addMessage("¡Hola! Soy Nover BOT de LegalNova. Escribe algo para comenzar", 'bot');
</script>
</body>
</html>